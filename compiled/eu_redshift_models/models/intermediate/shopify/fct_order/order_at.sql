

WITH order_raw AS (
         SELECT id,
            _fivetran_synced, 
            date(created_at) AS creation_date,
            app_id,
            billing_address_address_1,
            billing_address_address_2,
            billing_address_city,
            billing_address_company,
            billing_address_country,
            billing_address_country_code,
            billing_address_first_name,
            billing_address_id,
            billing_address_last_name,
            billing_address_latitude,
            billing_address_longitude,
            billing_address_name,
            billing_address_phone,
            billing_address_province,
            billing_address_province_code,
            billing_address_zip,
            browser_ip,
            buyer_accepts_marketing,
            cancel_reason,
            cancelled_at,
            cart_token,
            checkout_token,
            closed_at,
            confirmed,
            created_at,
            currency,
            current_total_duties_set,
            customer_id AS shop_cust_id,
            md5(lower(email)) AS customer_id,
            customer_locale,
            device_id,
            email,
            financial_status,
            fulfillment_status,
            landing_site_base_url,
            landing_site_ref,
            location_id,
            "substring"("order".name::text, 2) AS order_number,
            note,
            note_attributes,
            number,
            order_number AS original_order_number,
            original_total_duties_set,
            payment_gateway_names,
            presentment_currency,
            processed_at,
            processing_method,
            reference,
            referring_site,
            shipping_address_address_1,
            shipping_address_address_2,
            shipping_address_city,
            shipping_address_company,
            shipping_address_country,
            shipping_address_country_code,
            shipping_address_first_name,
            shipping_address_id,
            shipping_address_last_name,
            shipping_address_latitude,
            shipping_address_longitude,
            shipping_address_name,
            shipping_address_phone,
            shipping_address_province,
            shipping_address_province_code,
            shipping_address_zip,
            source_identifier,
            source_name,
            source_url,
            subtotal_price,
            NULL::double precision AS subtotal_price_chf,
            NULL::double precision AS subtotal_price_gbp,
            NULL::double precision AS subtotal_price_sek,
            subtotal_price_set,
            taxes_included,
            test,
            token,
            total_discounts,
            NULL::double precision AS total_discounts_chf,
            NULL::double precision AS total_discounts_gbp,
            NULL::double precision AS total_discounts_sek,
            total_discounts_set,
            total_line_items_price,
            NULL::double precision AS total_line_items_price_chf,
            NULL::double precision AS total_line_items_price_gbp,
            NULL::double precision AS total_line_items_price_sek,
            total_line_items_price_set,
            total_price,
            NULL::double precision AS total_price_chf,
            NULL::double precision AS total_price_gbp,
            NULL::double precision AS total_price_sek,
            total_price_set,
            total_price_usd,
            total_shipping_price_set,
            total_tax,
            NULL::double precision AS total_tax_chf,
            NULL::double precision AS total_tax_gbp,
            NULL::double precision AS total_tax_sek,
            total_tax_set,
            total_tip_received,
            NULL::double precision AS total_tip_received_chf,
            NULL::double precision AS total_tip_received_gbp,
            NULL::double precision AS total_tip_received_sek,
            total_weight,
            updated_at,
            user_id,
            'AT'::text AS shopify_shop,
            'EUR'::text AS currency_abbreviation
           FROM "airup_eu_dwh"."shopify_at"."order"
        ), 
        
        global_curr_eur AS (
         SELECT date(creation_datetime) AS creation_date,
            currency_abbreviation,
            conversion_rate_eur

          FROM "airup_eu_dwh"."odoo_currency"."dim_global_currency_rates"  
          WHERE currency_abbreviation::text = 'EUR'::text
        ),
        
         orders_enriched AS (
         SELECT id,
            _fivetran_synced,
            creation_date,
            app_id,
            billing_address_address_1,
            billing_address_address_2,
            billing_address_city,
            billing_address_company,
            billing_address_country,
            billing_address_country_code,
            billing_address_first_name,
            billing_address_id,
            billing_address_last_name,
            billing_address_latitude,
            billing_address_longitude,
            billing_address_name,
            billing_address_phone,
            billing_address_province,
            billing_address_province_code,
            billing_address_zip,
            browser_ip,
            buyer_accepts_marketing,
            cancel_reason,
            cancelled_at,
            cart_token,
            checkout_token,
            closed_at,
            confirmed,
            created_at,
            currency,
            current_total_duties_set,
            shop_cust_id,
            customer_id,
            customer_locale,
            device_id,
            email,
            financial_status,
            fulfillment_status,
            landing_site_base_url,
            landing_site_ref,
            location_id,
            order_number,
            note,
            note_attributes,
            number,
            order_number AS original_order_number,
            original_total_duties_set,
            payment_gateway_names,
            presentment_currency,
            processed_at,
            processing_method,
            reference,
            referring_site,
            shipping_address_address_1,
            shipping_address_address_2,
            shipping_address_city,
            shipping_address_company,
            shipping_address_country,
            shipping_address_country_code,
            shipping_address_first_name,
            shipping_address_id,
            shipping_address_last_name,
            shipping_address_latitude,
            shipping_address_longitude,
            shipping_address_name,
            shipping_address_phone,
            shipping_address_province,
            shipping_address_province_code,
            shipping_address_zip,
            source_identifier,
            source_name,
            source_url,
            (subtotal_price /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS subtotal_price,
            subtotal_price_chf,
            subtotal_price_gbp,
            subtotal_price_sek,
            subtotal_price_set,
            taxes_included,
            test,
            token,
            (total_discounts /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS total_discounts,
            NULL::double precision AS total_discounts_chf,
            NULL::double precision AS total_discounts_gbp,
            NULL::double precision AS total_discounts_sek,
            total_discounts_set,
            (total_line_items_price /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS total_line_items_price,
            NULL::double precision AS total_line_items_price_chf,
            NULL::double precision AS total_line_items_price_gbp,
            NULL::double precision AS total_line_items_price_sek,
            total_line_items_price_set,
            (total_price /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS total_price,
            NULL::double precision AS total_price_chf,
            NULL::double precision AS total_price_gbp,
            NULL::double precision AS total_price_sek,
            total_price_set,
            total_price_usd,
            total_shipping_price_set,
            (total_tax /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS total_tax,
            NULL::double precision AS total_tax_chf,
            NULL::double precision AS total_tax_gbp,
            NULL::double precision AS total_tax_sek,
            total_tax_set,
            (total_tip_received /
                CASE
                    WHEN global_curr_eur.conversion_rate_eur IS NOT NULL THEN global_curr_eur.conversion_rate_eur
                    ELSE 1::double precision
                END)::numeric(10,3)::double precision AS total_tip_received,
            NULL::double precision AS total_tip_received_chf,
            NULL::double precision AS total_tip_received_gbp,
            NULL::double precision AS total_tip_received_sek,
            total_weight,
            updated_at,
            user_id,
            shopify_shop,
            global_curr_eur.currency_abbreviation,
            global_curr_eur.conversion_rate_eur
           FROM order_raw
             LEFT JOIN global_curr_eur USING (currency_abbreviation, creation_date)
        )
 SELECT id,
    _fivetran_synced,
    creation_date,
    app_id,
    billing_address_address_1,
    billing_address_address_2,
    billing_address_city,
    billing_address_company,
    billing_address_country,
    billing_address_country_code,
    billing_address_first_name,
    billing_address_id,
    billing_address_last_name,
    billing_address_latitude,
    billing_address_longitude,
    billing_address_name,
    billing_address_phone,
    billing_address_province,
    billing_address_province_code,
    billing_address_zip,
    browser_ip,
    buyer_accepts_marketing,
    cancel_reason,
    cancelled_at,
    cart_token,
    checkout_token,
    closed_at,
    confirmed,
    created_at,
    currency,
    current_total_duties_set,
    shop_cust_id,
    customer_id,
    customer_locale,
    device_id,
    email,
    financial_status,
    fulfillment_status,
    landing_site_base_url,
    landing_site_ref,
    location_id,
    order_number,
    note,
    note_attributes,
    number,
    original_order_number,
    original_total_duties_set,
    payment_gateway_names,
    presentment_currency,
    processed_at,
    processing_method,
    reference,
    referring_site,
    shipping_address_address_1,
    shipping_address_address_2,
    shipping_address_city,
    shipping_address_company,
    shipping_address_country,
    shipping_address_country_code,
    shipping_address_first_name,
    shipping_address_id,
    shipping_address_last_name,
    shipping_address_latitude,
    shipping_address_longitude,
    shipping_address_name,
    shipping_address_phone,
    shipping_address_province,
    shipping_address_province_code,
    shipping_address_zip,
    source_identifier,
    source_name,
    source_url,
    subtotal_price,
    subtotal_price_chf,
    subtotal_price_gbp,
    subtotal_price_sek,
    subtotal_price_set,
    taxes_included,
    test,
    token,
    total_discounts,
    total_discounts_chf,
    total_discounts_gbp,
    total_discounts_sek,
    total_discounts_set,
    total_line_items_price,
    total_line_items_price_chf,
    total_line_items_price_gbp,
    total_line_items_price_sek,
    total_line_items_price_set,
    total_price,
    total_price_chf,
    total_price_gbp,
    total_price_sek,
    total_price_set,
    total_price_usd,
    total_shipping_price_set,
    total_tax,
    total_tax_chf,
    total_tax_gbp,
    total_tax_sek,
    total_tax_set,
    total_tip_received,
    total_tip_received_chf,
    total_tip_received_gbp,
    total_tip_received_sek,
    total_weight,
    updated_at,
    user_id,
    shopify_shop,
    currency_abbreviation,
    conversion_rate_eur

   FROM orders_enriched
   
   -----incrememntal table macro---
  
  where _fivetran_synced >= (select max(_fivetran_synced) from "airup_eu_dwh"."shopify_global"."order_at")
  